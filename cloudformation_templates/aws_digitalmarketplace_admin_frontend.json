{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Digital Marketplace Admin Frontend Environment",

  "Parameters": {
    "KeyName": {
      "Type": "String",
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the server"
    },
    "APIAuthTokens": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Digital Marketplace API Auth Token"
    },
    "DigitalmarketplaceAPIURL": {
      "Type": "String",
      "Description": "Digital Markeplace API ELB URL"
    },
    "S3Bucket": {
      "Type": "String",
      "Description": "Document S3 Bucket name"
    },
    "AdminPasswordHash": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Password hash to use for admin app authentication"
    },
    "ApplicationName": {
      "Type": "String",
      "Description": "Elastic Beanstalk Application name"
    },
    "EnvironmentName": {
      "Type": "String",
      "Description": "Elastic Beanstalk Environment name"
    }
  },

  "Resources": {
    "InstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "EC2 instances security group.",
        "SecurityGroupIngress": []
      }
    },

    "IAMRole": {
      "Type": "AWS::IAM::Role",
      "Properties": {
        "AssumeRolePolicyDocument": {
          "Version" : "2012-10-17",
          "Statement": [{
            "Effect": "Allow",
            "Principal": {
              "Service": ["ec2.amazonaws.com"]
            },
            "Action": ["sts:AssumeRole"]
          }]
        },
        "Path": "/",
        "Policies": [{
          "PolicyName": "digitalmarketplace-admin-frontend-eb-policy",
          "PolicyDocument": {
            "Version" : "2012-10-17",
            "Statement": [{
              "Effect": "Allow",
              "Action": [
                "s3:Get*",
                "s3:List*",
                "s3:Put*",
                "cloudwatch:PutMetricData"
              ],
              "Resource": "*"
            }]
          }
        }]
      }
    },
    "InstanceProfile": {
      "Type": "AWS::IAM::InstanceProfile",
      "Properties": {
        "Path": "/",
        "Roles": [{
          "Ref": "IAMRole"
        }]
      }
    },

    "ConfigurationTemplate": {
      "Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
      "Properties": {
        "ApplicationName": {"Ref": "ApplicationName"},
        "Description": "Default Configuration Version 1.0",
        "SolutionStackName": "64bit Amazon Linux 2014.09 v1.1.0 running Python 2.7",
        "OptionSettings": [
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "DM_ADMIN_FRONTEND_API_AUTH_TOKEN",
            "Value": {"Ref": "APIAuthTokens"}
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "DM_API_URL",
            "Value": {"Ref": "DigitalmarketplaceAPIURL"}
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "DM_S3_DOCUMENT_BUCKET",
            "Value": {"Ref": "S3Bucket"}
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "DM_ADMIN_FRONTEND_PASSWORD_HASH",
            "Value": {"Ref": "AdminPasswordHash"}
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "SecurityGroups",
            "Value": {"Ref": "InstanceSecurityGroup"}
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "IamInstanceProfile",
            "Value": {"Ref": "InstanceProfile"}
          },
          {
            "Namespace": "aws:elasticbeanstalk:container:python:staticfiles",
            "OptionName": "/static/",
            "Value": "app/static/"
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "EC2KeyName",
            "Value": {"Ref": "KeyName"}
          }
        ]
      }
    },

    "Environment": {
      "Type": "AWS::ElasticBeanstalk::Environment",
      "Properties": {
        "ApplicationName": {"Ref": "ApplicationName"},
        "EnvironmentName": {"Ref": "EnvironmentName"},
        "TemplateName": {"Ref": "ConfigurationTemplate"},
        "Description": "Digital Marketplace EB Environment"
      }
    }
  },

  "Outputs": {
    "Environment": {
      "Description": "Digital Marketplace EB environment",
      "Value": {"Ref": "Environment"}
    },
    "URL": {
      "Description": "URL of the AWS Elastic Beanstalk Environment",
      "Value": {
        "Fn::Join": ["", [
          "http://",
          {"Fn::GetAtt": ["Environment", "EndpointURL"]}
        ]]
      }
    }
  }
}
