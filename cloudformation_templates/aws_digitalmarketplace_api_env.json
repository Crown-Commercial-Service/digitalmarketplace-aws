{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Digital Marketplace API Environment",

  "Parameters": {
    "DBName": {
      "Type": "String",
      "Description": "Database name"
    },
    "DBUser": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database admin account name"
    },
    "DBPassword": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Database admin account password"
    },
    "DBInstanceType": {
      "Type": "String",
      "Description": "Database instance type"
    },
    "DBAllocatedStorage": {
      "Type": "String",
      "Description": "Database allocated storage"
    },
    "KeyName": {
      "Type": "String",
      "Description" : "Name of an existing EC2 KeyPair to enable SSH access to the server"
    },
    "APIAuthTokens": {
      "NoEcho": "true",
      "Type": "String",
      "Description": "Digital Marketplace API Auth Token"
    },
    "ApplicationName": {
      "Type": "String",
      "Description": "Elastic Beanstalk Application name"
    },
    "EnvironmentName": {
      "Type": "String",
      "Description": "Elastic Beanstalk Environment name"
    }
  },

  "Resources": {
    "InstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "RDS allows ingress from EC2 instances in this group.",
        "SecurityGroupIngress": []
      }
    },

    "RDSInstanceSecurityGroup": {
      "Type": "AWS::EC2::SecurityGroup",
      "Properties": {
        "GroupDescription": "Digital Marketplace API RDS Instance security group",
        "SecurityGroupIngress": [{
          "IpProtocol": "tcp",
          "FromPort": "5432",
          "ToPort": "5432",
          "SourceSecurityGroupName": {"Ref" : "InstanceSecurityGroup"}
        }]
      }
    },

    "DigitalMarketplaceAPIDB": {
      "Type": "AWS::RDS::DBInstance",
      "Properties": {
        "Engine": "postgres",
        "DBName": {"Ref": "DBName"},
        "MasterUsername": {"Ref": "DBUser"},
        "DBInstanceClass": {"Ref": "DBInstanceType"},
        "AllocatedStorage": {"Ref": "DBAllocatedStorage"},
        "MasterUserPassword": {"Ref": "DBPassword"},
        "VPCSecurityGroups": [{"Fn::GetAtt": ["RDSInstanceSecurityGroup", "GroupId"]}]
      }
    },

    "DigitalMarketplaceAPIConfigurationTemplate": {
      "Type": "AWS::ElasticBeanstalk::ConfigurationTemplate",
      "Properties": {
        "ApplicationName": {"Ref": "ApplicationName"},
        "Description": "Default Configuration Version 1.0",
        "SolutionStackName": "64bit Amazon Linux 2014.09 v1.1.0 running Python 2.7",
        "OptionSettings": [
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "SQLALCHEMY_DATABASE_URI",
            "Value": {
              "Fn::Join": [
                "",
                [
                  "postgres://",
                  {"Ref": "DBUser"},
                  ":",
                  {"Ref": "DBPassword"},
                  "@",
                  {"Fn::GetAtt": ["DigitalMarketplaceAPIDB", "Endpoint.Address"]},
                  ":",
                  {"Fn::GetAtt": ["DigitalMarketplaceAPIDB", "Endpoint.Port"]},
                  "/",
                  {"Ref": "DBName"}
                ]
              ]
            }
          },
          {
            "Namespace": "aws:elasticbeanstalk:application:environment",
            "OptionName": "AUTH_TOKENS",
            "Value": {"Ref": "APIAuthTokens"}
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "SecurityGroups",
            "Value": {"Ref": "InstanceSecurityGroup"}
          },
          {
            "Namespace": "aws:autoscaling:launchconfiguration",
            "OptionName": "EC2KeyName",
            "Value": {"Ref": "KeyName"}
          }
        ]
      }
    },

    "DigitalMarketplaceAPIEnvironment": {
      "Type": "AWS::ElasticBeanstalk::Environment",
      "Properties": {
        "ApplicationName": {"Ref": "ApplicationName"},
        "EnvironmentName": {"Ref": "EnvironmentName"},
        "TemplateName": {"Ref": "DigitalMarketplaceAPIConfigurationTemplate"},
        "Description": "Digital Marketplace API Environment"
      }
    }
  },

  "Outputs": {
    "RDSSecurityGroup": {
      "Description": "RDS security group",
      "Value": {"Ref": "RDSInstanceSecurityGroup"}
    }
  }
}
