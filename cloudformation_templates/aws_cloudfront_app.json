{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Digital Marketplace Application CloudFront Distribution",

  "Parameters": {
    "Origin": {
      "Type": "String",
      "Description": "The origin domain for the upstream application."
    },
    "Domain": {
      "Type": "String",
      "Description": "The domain CloudFront should serve off."
    },
    "HostedZoneName": {
      "Type": "String",
      "Description": "The Route53 hosted zone"
    },
    "LogsBucket": {
      "Type": "String",
      "Description": "S3 bucket name for the logs"
    },
    "IamCertificateId": {
      "Type": "String",
      "Description": "IAM SSL certificate ID"
    }
  },

  "Resources": {
    "CloudFrontDistribution": {
      "Type": "AWS::CloudFront::Distribution",
      "Properties": {
        "DistributionConfig": {
          "Origins": [
            {
              "DomainName": {"Ref": "Origin"},
              "Id": "OriginId",
              "CustomOriginConfig": {
                "HTTPPort": "80",
                "OriginProtocolPolicy": "match-viewer"
              }
            }
          ],
          "Enabled": true,
          "Logging": {
            "IncludeCookies": false,
            "Bucket": {"Ref": "LogsBucket"},
            "Prefix": {
              "Fn::Join": ["", [
                "cloudfront/",
                {"Ref": "Domain"},
                "/"
              ]]
            }
          },

          "Aliases": [ {"Ref": "Domain"} ],

          "DefaultCacheBehavior": {
            "TargetOriginId": "OriginId",
            "AllowedMethods": ["POST", "PATCH", "GET", "DELETE", "OPTIONS", "PUT", "HEAD" ],
            "ViewerProtocolPolicy": "redirect-to-https",
            "SmoothStreaming": false,
            "ForwardedValues": {
              "Headers": ["Authorization", "Host"],
              "QueryString": true
            }
          },
          "PriceClass": "PriceClass_100",
          "ViewerCertificate": {
            "IamCertificateId": {"Ref": "IamCertificateId"},
            "SslSupportMethod": "sni-only",
            "MinimumProtocolVersion": "TLSv1"
          }
        }
      }
    },
    "Route53RecordSet": {
      "Type": "AWS::Route53::RecordSet",
      "Properties": {
        "HostedZoneName": {"Ref": "HostedZoneName"},
        "Name": {"Fn::Join": ["",[
            {"Ref": "Domain"}, "."]]
        },
        "Type": "CNAME",
        "ResourceRecords": [
          {"Fn::GetAtt": ["CloudFrontDistribution", "DomainName"]}
        ],
        "TTL": "300"
      }
    }
  }
}
