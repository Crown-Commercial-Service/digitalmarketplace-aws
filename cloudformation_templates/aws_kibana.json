{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Kibana AWS Elasticsearch domain with CloudWatch streaming",
  "Parameters": {
    "DomainName": {
      "Type": "String",
      "Description": "Domain name for AWS Elasticsearch service"
    },
    "InstanceType": {
      "Type": "String",
      "Description": "AWS Elasticsearch instance type"
    },
    "UserIPs": {
      "Type": "CommaDelimitedList",
      "Description": "List of IP addresses that can access the Elasticsearch domain"
    }
  },

  "Resources": {
    "ElasticsearchDomain": {
      "Type": "AWS::Elasticsearch::Domain",
      "Properties": {
        "DomainName": {"Ref": "DomainName"},
        "EBSOptions": {
          "EBSEnabled": true,
          "VolumeSize": 50,
          "VolumeType": "gp2"
        },
        "ElasticsearchClusterConfig": {
          "InstanceType": {"Ref": "InstanceType"},
          "InstanceCount": 1
        },
        "AccessPolicies": {
          "Version": "2012-10-17",
          "Statement": [{
            "Sid": "",
            "Effect": "Allow",
            "Principal": {"AWS": "*"},
            "Action": "es:*",
            "Resource": "arn:aws:es:*",
            "Condition": {
              "IpAddress": {
                "aws:SourceIp": {"Ref": "UserIPs"}
              }
            }
          }]
        }
      }
    }
  },
  "Outputs": {
    "Name": {
      "Description": "Elasticsearch domain name",
      "Value": {"Ref": "ElasticsearchDomain"}
    },
    "Domain": {
      "Description": "Elasticsearch domain endpoint",
      "Value": {"Fn::GetAtt": ["ElasticsearchDomain", "DomainEndpoint"]}
    },
    "URL" : {
      "Value" : {"Fn::Join": ["", [
        "https://", {"Fn::GetAtt": ["ElasticsearchDomain", "DomainEndpoint"]}
      ]]},
      "Description" : "Elasticsearch domain URL"
    }
  }
}
