{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "CloudWatch Logs subscription to stream logs to AWS Lambda",
  "Parameters": {
    "Lambda": {
      "Type": "String",
      "Description": "Destination lambda function ARN"
    },
    "LogGroupName": {
      "Type": "String",
      "Description": "Source CloudWatch log group"
    },
    "FilterPattern": {
      "Type": "String",
      "Description": "CloudWatch filter expression restricting what gets streamed"
    }
  },

  "Resources": {
    "LambdaInvokePermission": {
      "Type": "AWS::Lambda::Permission",
      "Properties": {
        "FunctionName" : {"Ref": "Lambda"},
        "Action": "lambda:InvokeFunction",
        "Principal": {"Fn::Join": [".", ["logs", {"Ref": "AWS::Region"}, "amazonaws.com"]]},
        "SourceAccount": { "Ref" : "AWS::AccountId" }
      }
    },

    "SubscriptionFilter" : {
      "Type" : "AWS::Logs::SubscriptionFilter",
      "DependsOn": "LambdaInvokePermission",
      "Properties" : {
        "DestinationArn" : {"Ref": "Lambda"},
        "LogGroupName" : {"Ref" : "LogGroupName"},
        "FilterPattern" : {"Ref": "FilterPattern"}
      }
    }
  },

  "Outputs": {
    "Name": {
      "Description": "Subscription filter name",
      "Value": {"Ref": "SubscriptionFilter"}
    }
  }
}
