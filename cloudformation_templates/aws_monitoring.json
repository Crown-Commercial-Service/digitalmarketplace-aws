{
  "AWSTemplateFormatVersion": "2010-09-09",
  "Description": "Monitoring log group",

  "Parameters": {
    "LogGroupName": {
      "Type": "String",
      "Description": "The log group name"
    },
    "RetentionInDays": {
      "Type": "Number",
      "Description": "Number of days logs should be kept before being deleted."
    },
    "Email": {
      "Type": "String",
      "Description": "The email address that alert emails will go to."
    }
  },

  "Resources": {
    "LogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {"Ref": "LogGroupName"},
        "RetentionInDays": {"Ref": "RetentionInDays"}
      }
    },

    "JSONLogGroup": {
      "Type": "AWS::Logs::LogGroup",
      "Properties": {
        "LogGroupName": {"Fn::Join": ["", [{"Ref": "LogGroupName"}, "-json"]]},
        "RetentionInDays": 30
      }
    },

    "MonitoringSNSTopic": {
      "Type": "AWS::SNS::Topic",
      "Properties": {
        "DisplayName": "MonitoringEvents",
        "Subscription": [
          {
            "Protocol": "email",
            "Endpoint": {"Ref": "Email"}
          }
        ]
      }
    },

    "RDSEventSubscription": {
      "Type": "AWS::RDS::EventSubscription",
      "Properties": {
        "Enabled": true,
        "EventCategories": ["deletion"],
        "SnsTopicArn": {"Ref": "MonitoringSNSTopic"},
        "SourceType": "db-instance"
      }
    },

    "CloudWatchMetricNginxRequestTime": {
      "Type": "AWS::Logs::MetricFilter",
      "Properties": {
        "LogGroupName": {"Ref": "JSONLogGroup"},
        "FilterPattern": "{ $.logType = nginx-access }",
        "MetricTransformations": [
          {
            "MetricName": "requestTime",
            "MetricNamespace": {"Fn::Join": ["/", [{"Ref": "LogGroupName"}, "Nginx"]]},
            "MetricValue": "$.requestTime"
          }
        ]
      }
    }
  },

  "Outputs": {
    "LogGroupName": {
      "Description": "Log group",
      "Value": {"Ref": "LogGroup"}
    },
    "JSONLogGroupName": {
      "Description": "JSON log group",
      "Value": {"Ref": "JSONLogGroup"}
    },
    "MonitoringSNSTopic": {
      "Description": "SNS topic for monitoring events",
      "Value": {"Ref": "MonitoringSNSTopic"}
    }
  }
}
