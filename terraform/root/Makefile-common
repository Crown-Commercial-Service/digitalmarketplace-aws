.DEFAULT_GOAL := help
SHELL := /bin/bash

S3_BUCKET = digitalmarketplace-terraform-state${S3_BUCKET_POSTFIX}

.PHONY: help
help:
	@cat $(MAKEFILE_LIST) | grep -E '^[a-zA-Z_-]+:.*?## .*$$' | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "\033[36m%-30s\033[0m %s\n", $$1, $$2}'

.PHONY: check-env-vars
check-env-vars: ## Check mandatory environment variables
	$(if ${S3_BUCKET_POSTFIX},,$(error Must specify S3_BUCKET_POSTFIX))
	$(if ${TERRAFORM_PROJECT},,$(error Must specify TERRAFORM_PROJECT))

.PHONY: init
init:: ## Run init
	terraform get
	terraform remote config \
		-backend=S3 \
		-backend-config="bucket=${S3_BUCKET}" \
		-backend-config='key=${TERRAFORM_PROJECT}/terraform.tfstate' \
		-backend-config='region=eu-west-1' \
		-backend-config='encrypt=true'

.PHONY: refresh
refresh: check-env-vars init ## Run terraform plan
	. .envrc && \
	terraform refresh \
		-var-file=../common.tfvars \
		-var-file=<(./../../scripts/extract_secrets.sh)

.PHONY: plan
plan: check-env-vars init ## Run terraform plan
	. .envrc && \
	terraform plan \
		-var-file=../common.tfvars \
		-var-file=<(./../../scripts/extract_secrets.sh)

.PHONY: apply
apply: check-env-vars init ## Run terraform apply
	. .envrc && \
	terraform apply \
		-var-file=../common.tfvars \
		-var-file=<(./../../scripts/extract_secrets.sh)

.PHONY: plan-resource
plan-resource: check-env-vars init ## Run terraform plan with a specific resource target
	$(if ${TERRAFORM_TARGET},,$(error Must specify TERRAFORM_TARGET))
	. .envrc && \
	terraform plan \
		-var-file=../common.tfvars \
		-var-file=<(./../../scripts/extract_secrets.sh) \
		-target=$(shell echo ${TERRAFORM_TARGET} | sed -e 's/,/ -target=/g')

.PHONY: apply-resource
apply-resource: check-env-vars init ## Run terraform apply with a specific resource target
	$(if ${TERRAFORM_TARGET},,$(error Must specify TERRAFORM_TARGET))
	. .envrc && \
	terraform apply \
		-var-file=../common.tfvars \
		-var-file=<(./../../scripts/extract_secrets.sh) \
		-target=$(shell echo ${TERRAFORM_TARGET} | sed -e 's/,/ -target=/g')

.PHONY: upload-state
upload-state: check-env-vars ## Upload the local state file to S3, use it carefully
	. .envrc && \
	aws s3 cp --region eu-west-1 --sse AES256 .terraform/terraform.tfstate s3://${S3_BUCKET}/${TERRAFORM_PROJECT}/terraform.tfstate
